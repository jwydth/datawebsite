{% extends "base.html" %} {% block title %} {% if q %}Results for “{{ q }}” · {{
BRAND }}{% else %}Discover · {{ BRAND }}{% endif %} {% endblock %} {% block
content %} {% if q %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div class="small text-secondary">
    Found <strong>{{ count or 0 }}</strong> item{{ '' if (count or 0)==1 else
    's' }} for “{{ q }}”.
    <span class="badge-soft ms-2">Sorted by recommendations</span>
  </div>
  <a class="btn btn-outline-primary btn-sm" href="{{ url_for('index') }}"
    >Clear</a
  >
</div>
{% else %}
<h5 class="mb-3">Top recommended items</h5>
{% endif %}

<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
  {% for it in items %} {# pull stats from rec_map (provided by the view) #} {%
  set stats = rec_map.get(it.id, {'rec_sum': 0, 'review_count': 0}) %} {% set
  rec = stats.rec_sum|int %} {% set total = stats.review_count|int %} {% set
  ratio = (100.0 * rec / (total if total > 0 else 1)) %}

  <div class="col">
    <div class="card h-100 overflow-hidden position-relative">
      <img
        class="item-img"
        src="https://picsum.photos/seed/{{ it.id }}/600/400"
        alt="{{ it.title }}"
        data-fallback="{{ url_for('static', filename='placeholder.jpg') }}"
        onerror="this.onerror=null; this.src=this.dataset.fallback;"
      />

      <!-- rank badge (list order) -->
      <div class="corner-badge">#{{ loop.index }}</div>

      <div class="card-body">
        <h5 class="card-title mb-1">{{ it.title }}</h5>
        <div class="small text-secondary mb-2">
          {{ it.class_name }} · {{ it.department_name }}
        </div>

        <p class="card-text small mb-3">
          {{ (it.description or '')[:140] }}{% if (it.description or '')|length
          > 140 %}…{% endif %}
        </p>

        <!-- recommendation stats -->
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span class="badge-soft">👍 {{ rec }} recommended</span>
          <span class="text-secondary small">
            {{ total }} reviews · {{ ratio|round(1) }}%
          </span>
        </div>

        <!-- recommendation meter (uses scaleX for sub-pixel precision) -->
        <div
          class="rec-meter mb-3"
          role="progressbar"
          aria-valuemin="0"
          aria-valuemax="100"
          aria-valuenow="{{ ratio|round(1) }}"
        >
          <div
            class="rec-fill"
            style="transform: scaleX({{ (ratio/100.0) }});"
          ></div>
        </div>

        <a
          class="btn btn-outline-primary btn-sm"
          href="{{ url_for('item_detail', item_id=it.id) }}"
        >
          View details
        </a>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

{% if not items %}
<div class="text-secondary mt-4">
  No items matched. Try broader keywords like “dress”, “jeans”, or “tops”.
</div>
{% endif %} {% endblock %}
