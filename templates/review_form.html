{% extends "base.html" %} {% block title %}New Review · winter{% endblock %} {%
block content %}
<div class="row g-4">
  <div class="col-lg-8">
    <div class="card p-3 p-md-4">
      <h4 class="mb-3">Write a review</h4>

      <form method="post" id="review-form">
        <div class="mb-3">
          <label class="form-label"
            >Title <span class="text-secondary">(optional)</span></label
          >
          <input class="form-control" name="title" />
        </div>

        <div class="mb-3">
          <label class="form-label">Review description</label>
          <textarea
            class="form-control"
            rows="6"
            name="body"
            required
            placeholder="Share fit, fabric, style and quality…"
          ></textarea>
          <div class="input-hint mt-1">
            The model reads this to suggest a recommendation.
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Rating</label>
          <select class="form-select" name="rating">
            {% for n in [5,4,3,2,1] %}
            <option value="{{ n }}">{{ n }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Suggestion block: starts disabled & shows a placeholder -->
        <div class="mb-3">
          <label class="form-label"
            >Model’s suggestion (you can override)</label
          >
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <select
              class="form-select w-auto"
              name="recommend_label"
              id="recommend_label"
              disabled
            >
              <option value="" selected>— waiting —</option>
              <option value="1">1 (recommended)</option>
              <option value="0">0 (not recommended)</option>
            </select>

            <button
              type="button"
              id="btnSuggest"
              class="btn btn-outline-primary btn-sm"
              disabled
            >
              Get suggestion
            </button>

            <span id="suggestion_chip" class="badge-soft"
              >Type your review to enable suggestion…</span
            >
          </div>
          <div class="input-hint mt-1">
            We’ll only predict after you’ve written enough.
          </div>
        </div>

        <!-- Records the model's suggestion once computed -->
        <input type="hidden" name="suggested" id="suggested" value="" />

        <div class="d-flex gap-2">
          <button class="btn btn-primary" id="btnPublish" disabled>
            <i class="bi bi-send"></i> Publish review
          </button>
          <a
            class="btn btn-outline-primary"
            href="{{ url_for('item_detail', item_id=item.id) }}"
            >Cancel</a
          >
        </div>
      </form>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="hero h-100">
      <div class="badge-soft mb-2">You’re reviewing</div>
      <h5 class="mb-1">{{ item.title }}</h5>
      <div class="small text-secondary">
        {{ item.class_name }} · {{ item.department_name }}
      </div>
      <div class="text-secondary mt-3">
        {{ (item.description or '')[:220] }}{% if (item.description or
        '')|length > 220 %}…{% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  const form = document.getElementById("review-form");
  const select = document.getElementById("recommend_label");
  const suggested = document.getElementById("suggested");
  const chip = document.getElementById("suggestion_chip");
  const btn = document.getElementById("btnSuggest");
  const btnPublish = document.getElementById("btnPublish");

  const titleEl = form.querySelector('input[name="title"]');
  const bodyEl = form.querySelector('textarea[name="body"]');

  // Require a minimum amount of text before suggesting (you can raise this to 40+ later)
  const MIN_LEN = 1;

  function canSuggest() {
    const len = (titleEl.value + " " + bodyEl.value).trim().length;
    return len >= MIN_LEN;
  }

  function resetSuggestionUI(msg) {
    select.disabled = true;
    select.value = "";
    suggested.value = "";
    btnPublish.disabled = true;
    chip.textContent = msg || `Type at least ${MIN_LEN} characters to suggest`;
  }

  function updateState() {
    if (canSuggest()) {
      btn.disabled = false;
      chip.textContent = "Ready to suggest";
    } else {
      btn.disabled = true;
      resetSuggestionUI();
    }
  }

  async function suggestNow() {
    if (!canSuggest()) return;
    btn.disabled = true;
    chip.textContent = "Predicting…";

    const fd = new FormData(form);
    try {
      const res = await fetch('{{ url_for("suggest_label") }}', {
        method: "POST",
        body: fd,
      });
      const txt = (await res.text()).trim(); // backend returns plain "0" or "1"
      const v = parseInt(txt, 10);
      if (v !== 0 && v !== 1) {
        resetSuggestionUI("Prediction failed");
        return;
      }

      select.disabled = false;
      select.value = String(v);
      suggested.value = String(v);
      chip.textContent =
        v === 1
          ? `Model suggests: Recommended`
          : `Model suggests: Not recommended`;

      btnPublish.disabled = false; // allow publishing after a real prediction
    } catch (e) {
      resetSuggestionUI("Suggestion unavailable");
    } finally {
      btn.disabled = false;
    }
  }

  btn.addEventListener("click", suggestNow);
  titleEl.addEventListener("input", updateState);
  bodyEl.addEventListener("input", updateState);

  // Optional: auto-suggest when user leaves a field
  // titleEl.addEventListener("blur", () => canSuggest() && suggestNow());
  // bodyEl.addEventListener("blur",  () => canSuggest() && suggestNow());

  updateState();
</script>
{% endblock %}
